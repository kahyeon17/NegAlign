# NegAlign Setup Guide

## Overview

NegAlign is now a **standalone project** located at `/home/kahyeon/research/NegAlign/`. It has been restructured to be independent from the NegRefine codebase while still leveraging some of its utilities.

## Directory Structure

```
/home/kahyeon/research/NegAlign/
├── utils/                       # Copied utilities from NegRefine
│   ├── class_names.py           # ImageNet class names and prompt templates
│   ├── create_negs.py           # Negative label generation
│   ├── ood_evaluate.py          # OOD evaluation metrics
│   └── __init__.py
├── data/                        # Created by setup.sh
│   ├── neg_labels_noun.txt      # Copied from NegRefine
│   ├── neg_labels_adj.txt       # Copied from NegRefine
│   └── negatives_split/         # Generated by split_negatives_by_clip.py
│       ├── neg_word_scores.csv
│       ├── neg_object.txt
│       ├── neg_background.txt
│       └── neg_ambiguous.txt
├── split_negatives_by_clip.py  # CLIP-based word classification
├── cam_bg.py                    # Grad-CAM for background extraction
├── clip_negalign.py             # Main NegAlign model
├── test_waterbirds_negalign.py  # WaterBirds evaluation
├── example_usage.py             # Usage examples
├── setup.sh                     # Setup script (copies data)
├── quickstart.sh                # Quick start automation
├── README.md                    # Main documentation
└── SETUP_GUIDE.md               # This file
```

## Setup Steps

### 1. Install Dependencies

```bash
cd /home/kahyeon/research/NegAlign
pip install torch torchvision clip scipy pandas tqdm
```

### 2. Run Setup Script

The setup script copies negative labels from NegRefine:

```bash
bash setup.sh
```

**What it does:**
- Creates `./data/` directory
- Copies `neg_labels_noun.txt` and `neg_labels_adj.txt` from NegRefine
- Default source: `../negrefine_analysis/NegRefine/output/imagenet/seed_0/`

**Custom path:**
```bash
export NEGREFINE_PATH=/custom/path/to/NegRefine/output/imagenet/seed_0
bash setup.sh
```

**Manual setup:**
```bash
mkdir -p ./data
cp /path/to/neg_labels_noun.txt ./data/
cp /path/to/neg_labels_adj.txt ./data/
```

### 3. Run Quick Start

```bash
bash quickstart.sh
```

**What it does:**
1. Checks Python and PyTorch installation
2. Splits negative labels into obj/bg/ambiguous (if not already done)
3. Tests CAM extraction
4. Runs sanity check

## Usage

### Option 1: Quick Start (Automated)

```bash
bash setup.sh        # One-time setup
bash quickstart.sh   # Run pipeline
```

### Option 2: Manual Steps

```bash
# Step 1: Split negatives
python split_negatives_by_clip.py \
  --noun_file ./data/neg_labels_noun.txt \
  --adj_file ./data/neg_labels_adj.txt \
  --output_dir ./data/negatives_split \
  --tau 0.05 \
  --device cuda:0

# Step 2: Test CAM
python cam_bg.py

# Step 3: Sanity check
python clip_negalign.py
```

### Option 3: Python API

```python
from clip_negalign import CLIPNegAlign

# Initialize model
model = CLIPNegAlign(
    train_dataset='imagenet',
    device='cuda:0',
    output_folder='./data/',
    load_saved_labels=True,
    use_neglabel_star=True,
    use_role_aware_negatives=True,
    use_p_align=True,
    lambda_bg=1.0
)

# Process image
from PIL import Image
img = Image.open('test.jpg')
img_tensor = model.clip_preprocess(img).unsqueeze(0).to('cuda:0')
score = model.detection_score(img_tensor, img)
print(f"OOD score: {score:.4f}")
```

## Evaluation on WaterBirds

```bash
python test_waterbirds_negalign.py \
  --waterbirds_root /path/to/waterbirds \
  --placesbg_root /path/to/placesbg \
  --output_dir ./results/waterbirds_negalign \
  --use_neglabel_star \
  --use_role_aware \
  --use_p_align \
  --lambda_values 0.0 0.5 1.0 2.0 5.0 10.0
```

## Key Differences from Original NegRefine Integration

### Before (Inside NegRefine)
```
NegRefine/
├── src/
│   ├── class_names.py
│   ├── create_negs.py
│   └── ...
├── output/imagenet/seed_0/
│   ├── neg_labels_noun.txt
│   └── neg_labels_adj.txt
└── NegAlign/  # ← Nested inside
    ├── clip_negalign.py
    └── ...
```

Imports used relative paths:
```python
sys.path.insert(0, '../negrefine_analysis/NegRefine/src')
```

### After (Standalone)
```
research/
├── negrefine_analysis/NegRefine/  # Separate
└── NegAlign/  # ← Independent
    ├── utils/  # ← Copied utilities
    ├── data/   # ← Copied data
    └── ...
```

Imports use local paths:
```python
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'utils'))
```

## Troubleshooting

### Error: "Negative labels not found"

```bash
# Check if data exists
ls -la ./data/

# Re-run setup
bash setup.sh

# Or manually copy
cp /path/to/neg_labels_*.txt ./data/
```

### Error: "Module not found: class_names"

```bash
# Check utils directory
ls -la ./utils/

# Should contain:
# - class_names.py
# - create_negs.py
# - ood_evaluate.py
# - __init__.py
```

### Error: "PyTorch not installed"

```bash
pip install torch torchvision
# Or with CUDA:
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

## Notes

- **Independence**: NegAlign is now completely independent of NegRefine's directory structure
- **Data copying**: Setup script copies (not symlinks) data to ensure portability
- **Utils copying**: Essential utilities are copied to `./utils/` for independence
- **Default paths**: All default paths now use `./data/` instead of `../output/imagenet/seed_0/`
